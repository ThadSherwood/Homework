--The 10 states with the highest test positivity rate (positive tests / tests performed) for tests performed in the last 30 days.

--This is the version that is written specifically for 30 days from the last reported data.

WITH tempTable1 AS (SELECT state_name,COALESCE(SUM(new_results_reported),0) as PosTest from homework where overall_outcome = 'positive'and date >= '2024-05-02' group by state_name),
 tempTable2 AS (SELECT state_name, COALESCE(SUM(new_results_reported),0) as TotalTest from homework where date >= '2024-05-02' Group by state_name)
Select Top 10 a.state_name, (a.PosTest * 1.0 / nullif(b.TotalTest,0)*100) as ResultPercent
	from tempTable1 a
	inner join tempTable2 b on a.state_name = b.state_name
group by a.state_name, a.PosTest, b.TotalTest
order by ResultPercent desc

--This would be the version that is written for a dynamic date

WITH #tempTable1 AS (SELECT state_name,COALESCE(SUM(new_results_reported),0) as PosTest from homework where overall_outcome = 'positive'and and Date >= (select getdate() - 30) group by state_name),
 #tempTable2 AS (SELECT state_name, COALESCE(SUM(new_results_reported),0) as TotalTest from homework where Date >= (select getdate() - 30) Group by state_name)
Select Top 10 a.state_name,a.PosTest,b.TotalTest, (a.PosTest * 1.0/nullif(b.TotalTest,0)*100) as ResultPercent
	from #tempTable1 a
	inner join #tempTable2 b on a.state_name = b.state_name
group by a.state_name, a.PosTest, b.TotalTest
order by ResultPercent desc


--I was not able to get the percentages to calculate properly, initially.  For some reason the query is only calculating anything that is 100%.  Other percentages all come back as zero. 
--I spent the bulk of my time on this task and after just over 8 hours, eventually I looked googled "percentages only calculating at 100%" and found to add "* 1.0" to the dividend calculation and this fixed my issue. 
--From the Data, The  southeast coast of the US seems to be a hot spot based on the Carolina's and Virginia being in the top ten for positive tests during the last 30 days of the data that was available.
